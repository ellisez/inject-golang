package gen

import (
	. "github.com/ellisez/inject-golang/global"
	"github.com/ellisez/inject-golang/model"
	"github.com/ellisez/inject-golang/utils"
	"go/ast"
	"go/format"
	"go/token"
	"os"
	"path"
	"path/filepath"
)

func genFactoryFile(moduleInfo *model.ModuleInfo, dir string) error {
	fileDir := filepath.Join(dir, GenFactoryPackage)
	filename := filepath.Join(fileDir, GenFactoryFilename)

	err := utils.CreateDirectoryIfNotExists(fileDir)
	if err != nil {
		return err
	}

	file, err := os.OpenFile(filename, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, 0755)
	if err != nil {
		return err
	}
	defer file.Close()

	astFile := &ast.File{
		Name:  astIdent(GenFactoryPackage),
		Scope: ast.NewScope(nil),
	}

	genFactoryImportAst(moduleInfo, astFile)

	genFactoryNewAst(moduleInfo, astFile)

	addFileDoc(astFile, "// Code generated by \"inject-golang\"; DO NOT EDIT.")

	err = format.Node(file, token.NewFileSet(), astFile)
	if err != nil {
		return err
	}
	return nil
}

func genFactoryImportAst(moduleInfo *model.ModuleInfo, astFile *ast.File) {
	uniqueImport(astFile, "", path.Join(Mod.Package, GenPackage, "internal"))
	addImportDecl(astFile)
}

func genFactoryNewAst(_ *model.ModuleInfo, astFile *ast.File) {
	addDecl(astFile, astFuncDecl(
		nil,
		"New",
		nil,
		[]*ast.Field{
			astField("", astStarExpr(astSelectorExpr("ctx", "Ctx"))),
		},
		[]ast.Stmt{
			&ast.ReturnStmt{Results: []ast.Expr{
				&ast.CallExpr{
					Fun: astSelectorExpr("ctx", "New"),
				},
			}},
		},
	))
}
